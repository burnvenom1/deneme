name: Playwright with Tor

on:
  workflow_dispatch:
    inputs:
      CONTEXTS:
        description: 'Number of parallel contexts'
        required: false
        default: '3'
      HEADLESS:
        description: 'Run browser in headless mode'
        required: false
        default: 'true'

jobs:
  run-playwright:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm ci || npm install --no-audit --no-fund

      - name: Start TOR containers
        run: |
          set -e
          TOR_BASE_PORT=9050
          CONTEXTS=${{ github.event.inputs.CONTEXTS || '3' }}
          for i in $(seq 0 $((CONTEXTS-1))); do
            port=$((TOR_BASE_PORT + i))
            container_name="torch_${port}"
            docker run -d --rm --name $container_name -p $port:9050 dperson/torproxy socks
            echo "Started TOR container $container_name on port $port"
          done

      - name: Wait for TOR readiness
        run: |
          TOR_BASE_PORT=9050
          CONTEXTS=${{ github.event.inputs.CONTEXTS || '3' }}
          for i in $(seq 0 $((CONTEXTS-1))); do
            port=$((TOR_BASE_PORT + i))
            container_name="torch_${port}"
            ready=0
            for attempt in {1..15}; do
              if curl --socks5 127.0.0.1:$port -s https://check.torproject.org >/dev/null 2>&1; then
                ready=1
                echo "$container_name ready"
                break
              else
                echo "Waiting $container_name..."
                sleep 2
              fi
            done
            if [ $ready -eq 0 ]; then
              echo "Warning: $container_name may not be responding to SOCKS requests."
            fi
          done
          echo "Tor containers started (best-effort)."

      - name: Verify playwright script exists (.cjs)
        run: |
          if [ ! -f ./playwright-multi-context.cjs ]; then
            echo "ERROR: playwright-multi-context.cjs not found in repo root. Please ensure file is at repository root." >&2
            ls -la .
            exit 1
          fi
          echo "playwright-multi-context.cjs found."

      - name: Run Playwright multi-context script (.cjs)
        env:
          CONTEXTS: ${{ github.event.inputs.CONTEXTS || '3' }}
          HEADLESS: ${{ github.event.inputs.HEADLESS || 'true' }}
          TOR_BASE_PORT: 9050
          CHROME_PATH: /usr/bin/chromium-browser
        run: |
          echo "Starting node ./playwright-multi-context.cjs"
          node ./playwright-multi-context.cjs

      - name: Stop TOR containers
        if: always()
        run: |
          TOR_BASE_PORT=9050
          CONTEXTS=${{ github.event.inputs.CONTEXTS || '3' }}
          for i in $(seq 0 $((CONTEXTS-1))); do
            port=$((TOR_BASE_PORT + i))
            container_name="torch_${port}"
            docker stop $container_name || true
            echo "Stopped $container_name"
          done
